Google Apps Grouper Provisioner
==============================

This project is a [Grouper](http://grouper.internet2.edu/) provisioner that provisions (and deprovisions) Grouper groups and subjects to Google Apps for Education/Business. 

Unicon's work on the Google Apps Grouper Provisioner project is funded through a project with Oregon State University. It is intended that the products (source code and deliverables) of this project will be donated to the Grouper project, and that rights will be assigned to Internet2.

## Installation
1. Download or clone the source repository from https://github.com/Unicon/googleapps-grouper-provisioner.

1. Build the module and pull down dependencies by running `mvn clean package dependency:copy-dependencies -DskipTests -DincludeScope=runtime`.

   This will download all of the transitive dependencies and place them in `target/dependencies`, and build the provisioner module at `target/google-apps-provisioner-1.0-SNAPSHOT.jar`. 

## Basic Configuration
Settings for the Google Apps Grouper Provisioner are stored in the `grouper-loader.properties' file.

At a minimum the following must be added and set:

```
changeLog.consumer.google.class = edu.internet2.middleware.changelogconsumer.googleapps.GoogleAppsChangeLogConsumer
changeLog.consumer.google.quartzCron =

changeLog.consumer.google.serviceAccountPKCS12FilePath = <path to the PKCS12 key file generated by Google>
changeLog.consumer.google.serviceAccountEmail = <service account email address generated by Google>

changeLog.consumer.google.serviceImpersonationUser = <an existing Google account that will be used to make the Google Group changes>
changeLog.consumer.google.domain=<the email domain of the Google accounts and groups>

changeLog.consumer.google.groupIdentifierExpression=${groupName}
changeLog.consumer.google.subjectIdentifierExpression=${subjectId}

changeLog.consumer.google.provisionUsers=true
changeLog.consumer.google.subjectGivenNameField=givenName
changeLog.consumer.google.subjectSurameField=surname
#What should happen to groups that are deleted? archive, delete, ignore (leave as is; default value)
changeLog.consumer.google.handleDeletedGroup=delete
```
>Note: the `google` part of the string is arbitrary and can be any value. It is the name of the provisioner. Multiple Google Provisioners can be defined, but duplicate sets of properties will need to be created and have unique provisioner names. This name is also used for the attribute that is assigned to groups and stems that should be sync'ed.

The first items are created by following the instructions at [Perform Google Apps Domain-Wide Delegation of Authority](https://developers.google.com/admin-sdk/directory/v1/guides/delegation).
The account will need to be given these grants: `https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/apps.groups.settings`.

The serviceImpersonationUser is a fully qualified Google user account that the Google Apps Grouper Provisioner will be 
acting on behalf of, while the domain is the hostname of the user & google accounts.
 
The identiferExpressions can be used to manipulate the Google Group names and Google account names that will be provisioned. The 
properties are Java Expression Language (JEXL) patterns. ${groupName} is the full path of the group (e.ge qsob:courses:ACCT251:01).
${subjectId} is the subjectName coming from the subjects source. A sample JEXL string to pre-pend the group with "grp" and 
strip the first part of the stem would be `grp-${groupName.replace("qsob:courses", "")}`.  Colons are not permitted in the 
group name and will be replaced by a hyphen (-) if not replaced with something else (i.e. `.replace(":","_")`).

## Running
1. Add the module and dependencies to the CLASSPATH:
  * On Linux: `export CLASSPATH=<PROJECT_HOME>/target/google-apps-provisioner-1.0-SNAPSHOT.jar:<PROJECT_HOME>/target/dependency/*`
  * On Windows: `set CLASSPATH=<PROJECT_HOME>/target/google-apps-provisioner-1.0-SNAPSHOT.jar;<PROJECT_HOME>/target/dependency/*`
1. Start the Grouper Shell with the loader option: `gsh -loader`

## Marking Stems and Groups for Sync

The Google Provisioner uses an attribute assignment to determine which groups to sync. The attribute can be assigned to stems or to individual groups. The first time the provisioner starts up it will create the attribute. It will be put in the `etc:attribute:googleProvisioner` stem. The attribute will be named `syncToGoogle<provisioner_name>`, where provisioner name matches the property set: `changeLog.consumer.google.class = edu.internet2.middleware.changelogconsumer.googleapps.GoogleAppsChangeLogConsumer`.

### Assign the Attribute to the Stem
Assigning `the etc:attribute:googleProvisioner:syncToGooglegoogle` to the stem `qsuob:testStem` can be done with:

```java
grouperSession = GrouperSession.startRootSession();
groupStem = StemFinder.findByName(grouperSession, "qsuob:testStem", true);
attrSync = AttributeDefNameFinder.findByName("etc:attribute:googleProvisioner:syncToGooglegoogle",true);
groupStem.getAttributeDelegate().addAttribute(attrSync);
```

### Assign the Attribute to the Group
Assigning `the etc:attribute:googleProvisioner:syncToGooglegoogle` to the group `qsuob:testGroup` can be done with:

```java
grouperSession = GrouperSession.startRootSession();
groupTest = GroupFinder.findByName(grouperSession, "qsuob:testGroup", true);
attrSync = AttributeDefNameFinder.findByName("etc:attribute:googleProvisioner:syncToGooglegoogle", true);
groupTest.getAttributeDelegate().addAttribute(attrSync);
```

## Troubleshooting
Properties errors will be listed in `grouper_error.log`. 

To see debugging messages, add the line `log4j.logger.edu.internet2.middleware.changelogconsumer.googleapps = DEBUG, grouper_debug` to `GROUPER_HOME/config/log4j.properties`. Check the `grouper_debug.log` file.

## Acknowledgements
These individuals have provided guidance through out the development process:

* Andy Morgan, Oregon State University 
* Erica Lomax, Oregon State University
* David Langenberg, University of Chicago
* Chris Hyzer, University of Pennsylvania
* Jeff Pasch, New York University
* Gary Chapman, New York University
* Madan Dorairaj, New York University

